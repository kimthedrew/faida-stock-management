{% extends "base.html" %}

{% block content %}
<div class="sales-container" style="max-width:1200px;margin:20px auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2>Sales</h2>
        <div>
            <button onclick="window.print()" style="padding:8px 12px;margin-right:8px;">Print</button>
            <button id="exportCsvBtn" style="padding:8px 12px;">Export CSV</button>
        </div>
    </div>

    {% if not sorted_dates %}
        <div>No sales recorded yet.</div>
    {% endif %}

    {% for date in sorted_dates %}
    <div class="sales-day" style="background:#fff;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0;">{{ date }}</h3>
            <div style="font-weight:700;">Daily total: KES {{ daily_totals[date]|round(2)|format_currency }}</div>
        </div>

        {% for sale in grouped_sales[date] %}
        <div class="sale-row" style="border-top:1px solid #f0f0f0;padding-top:12px;padding-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div><strong>Sale #{{ sale.id }}</strong></div>
                    <div style="color:#666;font-size:13px;">Time: {{ sale.date | local_time }}</div>
                    <div style="color:#666;font-size:13px;">Sold by: {{ sale.created_by if sale.created_by is not none else 'Unknown' }}</div>

                    <div style="color:#666;font-size:13px;">Payment: {{ sale.payment_method|upper if sale.payment_method else 'N/A' }}</div>
                </div>

                <div style="text-align:right;">
                    <div style="font-weight:700;font-size:16px;">KES {{ sale.total_amount|round(2)|format_currency }}</div>
                    <div style="margin-top:6px;">
                        <a href="{{ url_for('receipt', sale_id=sale.id) }}" target="_blank" style="text-decoration:none;padding:6px 10px;border-radius:5px;background:#3498db;color:#fff;">Receipt</a>
                    </div>
                </div>
            </div>

            <!-- Items table -->
            <table style="width:100%;margin-top:10px;border-collapse:collapse;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th style="padding:8px;border:1px solid #eee;text-align:left;">Item</th>
                        <th style="padding:8px;border:1px solid #eee;text-align:center;width:90px;">Qty</th>
                        <th style="padding:8px;border:1px solid #eee;text-align:right;width:120px;">Unit</th>
                        <th style="padding:8px;border:1px solid #eee;text-align:right;width:140px;">Total</th>
                    </tr>
                </thead>
                <tbody>
                {% for it in sale.items %}
                    <tr>
                        <td style="padding:8px;border:1px solid #eee;">{{ it.stock_item.name if it.stock_item else ('Item #' ~ it.item_id) }}</td>
                        <td style="padding:8px;border:1px solid #eee;text-align:center;">{{ it.quantity }}</td>
                        <td style="padding:8px;border:1px solid #eee;text-align:right;">KES {{ it.price|round(2)|format_currency }}</td>
                        <td style="padding:8px;border:1px solid #eee;text-align:right;">KES {{ (it.price * it.quantity)|round(2)|format_currency }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="4" style="padding:8px;border:1px solid #eee;text-align:center;color:#777;">No items recorded for this sale</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script>
document.getElementById('exportCsvBtn')?.addEventListener('click', function() {
    // Build CSV in JS by scanning the DOM (simple client-side CSV export)
    let rows = [];
    rows.push(['Date', 'Sale ID', 'Time', 'Seller', 'Payment Method', 'Item', 'Qty', 'Unit Price', 'Line Total', 'Sale Total']);
    const dayContainers = document.querySelectorAll('.sales-day');
    dayContainers.forEach(day => {
        const date = day.querySelector('h3').innerText.trim();
        const saleRows = day.querySelectorAll('.sale-row');
        saleRows.forEach(sr => {
            const saleId = sr.querySelector('strong')?.innerText.replace('Sale #','').trim() || '';
            const time = sr.querySelector('div[style*="Time"]') ? sr.querySelector('div[style*="Time"]').innerText : '';
            const sellerText = sr.querySelector('div[style*="Sold by"]') ? sr.querySelector('div[style*="Sold by"]').innerText : '';
            const seller = sellerText.replace('Sold by:','').trim();
            const payment = (sr.querySelector('div[style*="Payment"]')?.innerText || '').replace('Payment:','').trim();
            const saleTotal = sr.querySelector('div[style*="KES"]')?.innerText.replace('KES','').trim() || '';
            // items
            const trs = sr.querySelectorAll('tbody tr');
            trs.forEach(tr => {
                if (tr.children.length < 4) return;
                const item = tr.children[0].innerText.trim();
                const qty = tr.children[1].innerText.trim();
                const unit = tr.children[2].innerText.replace('KES','').trim();
                const line = tr.children[3].innerText.replace('KES','').trim();
                rows.push([date, saleId, time, seller, payment, item, qty, unit, line, saleTotal]);
            });
        });
    });

    let csvContent = "data:text/csv;charset=utf-8," + rows.map(r => r.map(cell => '"' + ('' + (cell || '')).replace(/"/g,'""') + '"').join(',')).join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "sales_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
{% endblock %}
